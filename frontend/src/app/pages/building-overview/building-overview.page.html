<!--
  BUILDING OVERVIEW PAGE TEMPLATE

  This template displays all rooms in a building, categorized into three sections:
  1. Available Now (FREE rooms)
  2. Available Soon (busy rooms free within 30 min)
  3. Busy (occupied rooms)

  Data Binding:
  - freeRooms: Room[] - Displayed in "Available Now" section
  - availableSoonRooms: Room[] - Displayed in "Available Soon" section
  - busyRooms: Room[] - Displayed in "Busy" section
  - stats: Object - Header statistics (totalFree, availableSoon, totalBusy)
  - searchQuery: string - Search input value
  - selectedFloor: string - Currently selected floor filter
-->

<!-- Header: Navigation, building switcher, date/time picker, refresh button -->
<ion-header class="ion-no-border">
  <div class="header-wrapper">
    <div class="header-top">
      <div class="header-center">
        <!-- Building switcher: Shows current building -->
        <ion-select [(ngModel)]="selectedBuilding" (ionChange)="onBuildingChange()" placeholder="Select building..."
          [selectedText]="selectedBuilding" class="building-select building-switcher"
          [class.has-selection]="selectedBuilding" interface="action-sheet" justify="space-between">
          <ion-select-option *ngFor="let b of buildings" [value]="b.code">
            {{ b.code }} - {{ b.label }}
          </ion-select-option>
        </ion-select>
        <!-- Date/Time picker: Allows viewing room availability at specific date/time -->
        <div class="datetime-controls">
          <div class="datetime-trigger building-switcher" id="open-date-modal">
            <ion-icon name="calendar-clear-outline"></ion-icon>
            <span>{{ getFormattedDateTime() }}</span>
          </div>

          <ion-modal [keepContentsMounted]="true" trigger="open-date-modal" #datetimeModal
            class="datetime-modal ion-palette-light">
            <ng-template>
              <ion-datetime #datetime id="datetime" presentation="date-time" [minuteValues]="minuteValues"
                [(ngModel)]="selectedDateTimeISO" (ionChange)="onDateTimeChange($event)" hour-cycle="h23"
                locale="de-AT">
                <div slot="buttons" class="picker-footer">
                  <ion-button color="medium" fill="clear" (click)="datetime.cancel(); datetimeModal.dismiss()"
                    class="cancel-btn">
                    Cancel
                  </ion-button>
                  <ion-button color="primary" fill="clear" (click)="resetToNow()" class="reset-now-btn">
                    Now
                  </ion-button>
                  <ion-button color="primary" fill="solid" (click)="datetime.confirm(); datetimeModal.dismiss()"
                    class="apply-btn">
                    Apply
                  </ion-button>
                </div>
              </ion-datetime>
            </ng-template>
          </ion-modal>
        </div>
      </div>
    </div>

    <!-- Search Bar: Advanced search (room code, class name, teacher) -->
    <!-- Data: searchQuery (string) -->
    <!-- Action: onSearchChange() triggers applyFilters() -->
    <div class="search-wrapper">
      <ion-searchbar [(ngModel)]="searchQuery" (ionInput)="onSearchChange()" placeholder="Search rooms..."
        debounce="300" class="main-searchbar"></ion-searchbar>
    </div>

    <!-- Floor Filter: Filter rooms by floor -->
    <!-- Data: floorOptions (string[]) - includes 'all' + availableFloors -->
    <!-- Data: selectedFloor (string) - currently selected floor -->
    <!-- Action: onFloorChange() triggers applyFilters() -->
    <div class="floor-filter-wrapper">
      <div class="floor-chips">
        <button *ngFor="let floor of floorOptions" (click)="selectedFloor = floor; onFloorChange()"
          [class.active]="selectedFloor === floor" class="floor-btn">
          {{ floor === 'all' ? 'All Floors' : getFloorLabel(floor) }}
        </button>
      </div>
    </div>
  </div>
</ion-header>

<ion-content class="main-content">
  <ion-refresher slot="fixed" (ionRefresh)="loadData($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <div class="content-area">

    <!-- Loading State -->
    @if (loading && allRooms.length === 0) {
    <div class="state-container">
      <ion-spinner name="crescent"></ion-spinner>
      <p class="state-text">Loading rooms...</p>
    </div>
    }

    <!-- Error State -->
    @if (error && !loading){
    <div class="state-container error-state">
      <ion-icon name="alert-circle" class="state-icon"></ion-icon>
      <h3 class="state-title">Unable to Load Rooms</h3>
      <p class="state-text">{{ error }}</p>
      <button (click)="loadData()" class="action-btn">Tap to Retry</button>
    </div>
    }

    <!-- Empty Search State -->
    @if( freeRooms.length === 0 && !loading && !error){
    <div class="state-container error-state">
      <ion-icon name="search-outline" class="state-icon"></ion-icon>
      <h3 class="state-title">No Rooms Match Your Filters</h3>
      <p class="state-text">Try adjusting your search or floor filter</p>
      <button (click)="clearFilters()" class="action-btn">Clear Filters</button>
    </div>
    }

    <!-- ========== AVAILABLE NOW SECTION ========== -->
    <!-- Displays rooms that are currently FREE (status: 'FREE') -->
    <!-- Data: freeRooms (Room[]) - filtered and sorted by processRooms() -->
    <div *ngIf="!loading && !error && freeRooms.length > 0" class="section">
      <div class="section-header">
        <h2 class="section-title">
          <ion-icon name="checkmark-circle" class="title-icon free-icon"></ion-icon>
          Available
        </h2>
        <span class="section-badge">{{ freeRooms.length }}</span>
      </div>

      <!-- Room Cards: Each card represents one FREE room -->
      <div class="rooms-list">
        <div *ngFor="let room of freeRooms" (click)="openRoomDetail(room)" class="room-card free-card tappable">
          <!-- Left side: Room ID and metadata -->
          <div class="card-left">
            <div class="room-id" [innerHTML]="formatRoomIdWithBreaks(room.room_id)"></div>
          </div>

          <!-- Right side: Duration badge and time info -->
          <div class="card-right">
            <!-- Duration badge: Shows "Free for X" or "Free until end of day" -->
            <!-- Method: getFreeBadgeText(room) uses room.minutes_left and room.is_end_of_day -->
            <div class="duration-badge free-badge">
              <span>Free until {{ formatFreeUntil(room) }}</span>
            </div>
          </div>

          <!-- Chevron: Indicates card is clickable -->
          <ion-icon name="chevron-forward" class="card-chevron"></ion-icon>
        </div>
      </div>

      <!-- After Hours Notice -->
      <div *ngIf="isAfterHours()" class="after-hours-text">
        <ion-icon name="information-circle-outline"></ion-icon>
        <span>Building hours: 08:00 - 18:15</span>
      </div>
    </div>

    <!-- ========== AVAILABLE SOON SECTION ========== -->
    <!-- Displays busy rooms that will be free within 30 minutes -->
    <!-- Data: availableSoonRooms (Room[]) - populated by processRooms() -->
    <!-- These rooms are currently BUSY but will become FREE soon -->
    <div *ngIf="!loading && !error && availableSoonRooms.length > 0" class="section">
      <div class="section-header">
        <h2 class="section-title">
          <ion-icon name="time-outline" class="title-icon soon-icon"></ion-icon>
          Available Soon
        </h2>
        <span class="section-badge">{{ availableSoonRooms.length }}</span>
      </div>

      <!-- Room Cards: Each card represents one BUSY room that will be free soon -->
      <div class="rooms-list">
        <div *ngFor="let room of availableSoonRooms" (click)="openRoomDetail(room)"
          class="room-card soon-card tappable">
          <div class="card-left">
            <div class="room-id" [innerHTML]="formatRoomIdWithBreaks(room.room_id)"></div>
          </div>

          <div class="card-right">
            <div class="duration-badge soon-badge">
              <span>Busy until {{ formatFreeUntil(room) }}</span>
            </div>
          </div>

          <ion-icon name="chevron-forward" class="card-chevron"></ion-icon>
        </div>
      </div>
    </div>


    <!-- ========== BUSY SECTION ========== -->
    <!-- Displays rooms that are currently BUSY (status: 'BUSY') -->
    <!-- Data: busyRooms (Room[]) - filtered by processRooms() (excludes availableSoonRooms) -->
    <!-- Note: Limited to 8 rooms displayed (slice:0:8) -->
    <div *ngIf="!loading && !error && busyRooms.length > 0" class="section">
      <div class="section-header">
        <h2 class="section-title">
          <ion-icon name="lock-closed" class="title-icon busy-icon"></ion-icon>
          Busy
        </h2>
        <span class="section-badge">{{ busyRooms.length }}</span>
      </div>

      <!-- Room Cards: Each card represents one BUSY room -->
      <!-- Note: Only first 8 rooms shown (slice:0:8) -->
      <div *ngIf="busyRooms.length > 0" class="rooms-list">
        <div *ngFor="let room of busyRooms | slice:0:8" (click)="openRoomDetail(room)"
          class="room-card busy-card tappable">
          <div class="card-left">
            <div class="room-id" [innerHTML]="formatRoomIdWithBreaks(room.room_id)"></div>
          </div>

          <div class="card-right">
            <div class="busy-badge" [class.soon-badge]="room.availableSoon">
              <span *ngIf="room.availableSoon">Available Soon</span>
              <span *ngIf="!room.availableSoon">Busy until {{ formatFreeUntil(room) }}</span>
            </div>
          </div>

          <ion-icon name="chevron-forward" class="card-chevron"></ion-icon>
        </div>
      </div>

      <div *ngIf="busyRooms.length === 0" class="empty-section">
        <ion-icon name="checkmark-circle-outline" class="empty-icon"></ion-icon>
        <p>No rooms are busy right now</p>
      </div>

      <div *ngIf="busyRooms.length > 8" class="more-indicator">
        + {{ busyRooms.length - 8 }} more busy rooms
      </div>
    </div>

    <!-- No Data State -->
    <div *ngIf="!loading && !error && allRooms.length === 0" class="state-container">
      <ion-icon name="calendar-outline" class="state-icon"></ion-icon>
      <h3 class="state-title">No Rooms Available</h3>
      <p class="state-text">No rooms scheduled for this building right now</p>
      <button (click)="loadData()" class="action-btn">Refresh</button>
    </div>
  </div>
</ion-content>